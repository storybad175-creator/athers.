<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdrawals - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>

    <div class="admin-layout">
        <nav class="admin-sidebar">
            <div class="sidebar-brand">
                <h2>AETHER <span style="color:var(--color-primary)">//</span> ADMIN</h2>
            </div>
            <ul class="sidebar-nav">
                <li><a href="admin-dashboard.html">üìä Dashboard</a></li>
                <li><a href="hidden_control.html">‚ûï Create Tournament</a></li>
                <li><a href="admin-tournaments.html">üéÆ Tournaments</a></li>
                <li><a href="admin-players.html">üë• Players</a></li>
                <li><a href="admin-payments.html">üí≥ Payments</a></li>
                <li><a href="admin-withdrawals.html" class="active">üí∏ Withdrawals</a></li>
                <li><a href="admin-wallet.html">üí∞ Earnings</a></li>
                <li><a href="admin-settings.html">‚öôÔ∏è Settings</a></li>
            </ul>
            <div class="sidebar-footer"><button onclick="handleLogout()" class="btn" style="width:100%">LOGOUT</button>
            </div>
        </nav>

        <main class="admin-main">
            <div class="admin-header">
                <h1>WITHDRAWAL REQUESTS</h1>
            </div>

            <div class="filter-bar">
                <select id="filter-status" class="form-control" onchange="filterWithdrawals()">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>

            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>DATE</th>
                            <th>USER</th>
                            <th>AMOUNT</th>
                            <th>METHOD</th>
                            <th>DETAILS</th>
                            <th>STATUS</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawal-list"></tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let allWithdrawals = [];

        document.addEventListener('DOMContentLoaded', loadWithdrawals);

        async function loadWithdrawals() {
            try {
                allWithdrawals = await db.getWithdrawals();
                renderWithdrawals(allWithdrawals);
            } catch (err) {
                console.error(err);
            }
        }

        function renderWithdrawals(withdrawals) {
            const tbody = document.getElementById('withdrawal-list');
            if (withdrawals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="color:var(--color-text-muted)">No withdrawal requests</td></tr>';
                return;
            }

            tbody.innerHTML = withdrawals.map(w => {
                const statusClass = w.status === 'pending' ? 'status-pending' : (w.status === 'approved' ? 'status-approved' : 'status-rejected');
                const actions = w.status === 'pending' ? `
                    <button onclick="approveWithdrawal('${w.id}')" class="btn action-btn approve">APPROVE</button>
                    <button onclick="rejectWithdrawal('${w.id}')" class="btn action-btn reject">REJECT</button>
                ` : '‚Äî';

                return `
                    <tr>
                        <td style="color:#888">${new Date(w.createdAt).toLocaleString()}</td>
                        <td style="color:#aaa">${w.email?.substring(0, 25)}...</td>
                        <td style="color:var(--color-primary);font-weight:bold">‚Çπ${w.amount}</td>
                        <td style="color:#888">${w.paymentMethod?.toUpperCase() || 'UPI'}</td>
                        <td style="color:var(--color-secondary)">${w.paymentDetails || '‚Äî'}</td>
                        <td class="${statusClass}">${w.status?.toUpperCase()}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        function filterWithdrawals() {
            const status = document.getElementById('filter-status').value;
            let filtered = allWithdrawals;
            if (status) {
                filtered = filtered.filter(w => w.status === status);
            }
            renderWithdrawals(filtered);
        }

        async function approveWithdrawal(id) {
            if (!confirm('Approve this withdrawal? Make sure to send the payment manually.')) return;
            try {
                await db.approveWithdrawal(id);
                alert('Withdrawal approved! Remember to send payment via UPI/Bank/bKash.');
                loadWithdrawals();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function rejectWithdrawal(id) {
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;
            try {
                await db.rejectWithdrawal(id, reason);
                alert('Withdrawal rejected. Amount refunded to user wallet.');
                loadWithdrawals();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
    </script>
</body>

</html>
