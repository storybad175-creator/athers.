<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AETHER</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>

    <nav class="navbar">
        <div class="container nav-flex">
            <div class="brand">AETHER <span style="color:var(--color-secondary)">//</span> HUB</div>
            <div style="display:flex;gap:15px;align-items:center">
                <a href="earn.html" class="btn" style="color:gold;border-color:gold;text-decoration:none">üì∫ EARN
                    COINS</a>
                <a href="wallet.html" class="btn" style="display:flex;align-items:center;gap:8px;text-decoration:none">
                    üí∞ <span id="nav-balance">‚Çπ0</span>
                </a>
                <button onclick="handleLogout()" class="btn">LOGOUT</button>
            </div>
        </div>
    </nav>

    <div class="container">

        <!-- Player Stats Bar -->
        <div class="card" style="margin-bottom:30px; padding: 1.5rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px">
                <div>
                    <h2 id="user-welcome" style="margin:0; font-size:1.5rem">WELCOME, OPERATIVE</h2>
                    <p style="color:var(--color-text-muted); font-size:0.9rem">STATUS: ACTIVE | <span
                            id="user-region">--</span></p>
                </div>
                <div style="display:flex;gap:30px;text-align:center">
                    <div>
                        <div style="font-size:0.8rem;color:var(--color-text-muted)">WALLET</div>
                        <div id="stat-wallet"
                            style="font-size:1.8rem;color:var(--color-primary);font-family:var(--font-heading)">‚Çπ0</div>
                    </div>
                    <div>
                        <div style="font-size:0.8rem;color:var(--color-text-muted)">MATCHES</div>
                        <div id="stat-matches"
                            style="font-size:1.8rem;color:var(--color-secondary);font-family:var(--font-heading)">0
                        </div>
                    </div>
                    <a href="wallet.html" class="btn btn-primary" style="text-decoration:none;align-self:center">+ ADD
                        MONEY</a>
                </div>
            </div>
        </div>

        <!-- Tournament Filters -->
        <div
            style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px">
            <h3 style="color:var(--color-text-muted);margin:0">AVAILABLE TOURNAMENTS</h3>
            <div style="display:flex;gap:10px">
                <button onclick="filterTournaments('all')" class="btn filter-btn active" data-filter="all">ALL</button>
                <button onclick="filterTournaments('free')" class="btn filter-btn" data-filter="free">FREE</button>
                <button onclick="filterTournaments('paid')" class="btn filter-btn" data-filter="paid">PAID</button>
            </div>
        </div>

        <div id="tour-grid" class="grid grid-2">
            <!-- Dynamic -->
        </div>

    </div>

    <!-- Join Modal -->
    <div id="join-modal" class="modal-overlay">
        <div class="modal-content card" style="max-width:500px">
            <h2 style="color:var(--color-primary);margin-bottom:15px" id="join-title">JOIN TOURNAMENT</h2>
            <p style="color:var(--color-text-muted);margin-bottom:20px" id="join-info"></p>

            <div style="margin-bottom:20px">
                <label style="color:#888;font-size:0.8rem">BKASH NUMBER (Required for Payouts)</label>
                <input type="text" id="join-bkash" class="form-control" placeholder="01XXXXXXXXX" required>
            </div>

            <div id="payment-options">
                <label style="color:#888;font-size:0.8rem;margin-bottom:10px;display:block">SELECT PAYMENT
                    METHOD</label>
                <div class="grid grid-2" style="gap:10px;margin-bottom:20px">
                    <div class="payment-card active" onclick="selectPaymentMethod('money')" id="pm-money">
                        <div style="font-size:0.8rem;color:#888">MAIN WALLET</div>
                        <div style="font-size:1.5rem;color:var(--color-primary)" id="cost-money">‚Çπ0</div>
                        <div style="font-size:0.75rem;color:#666">Bal: <span id="bal-money">‚Çπ0</span></div>
                    </div>
                    <div class="payment-card" onclick="selectPaymentMethod('adcoin')" id="pm-adcoin">
                        <div style="font-size:0.8rem;color:#888">AD COINS</div>
                        <div style="font-size:1.5rem;color:gold" id="cost-adcoin">ü™ô 0</div>
                        <div style="font-size:0.75rem;color:#666">Bal: <span id="bal-adcoin">ü™ô 0</span></div>
                    </div>
                </div>
            </div>

            <div id="ad-watch-section"
                style="display:none; text-align:center; margin-bottom:20px; padding:15px; background:rgba(255,215,0,0.05); border:1px dashed gold">
                <p style="color:gold;margin-bottom:10px">Need more coins?</p>
                <a href="earn.html" class="btn"
                    style="border:1px solid gold; color:gold; text-decoration:none; display:inline-block">üì∫ GO TO AD
                    REWARD HUB</a>
            </div>

            <div style="margin-top:20px;display:flex;gap:10px">
                <button onclick="confirmJoin()" id="join-btn" class="btn btn-primary" style="flex:1">PAY & JOIN</button>
                <button onclick="closeJoinModal()" class="btn" style="flex:1">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let allTournaments = [];
        let currentUser = null;
        let selectedTournament = null;
        let userBalance = 0;
        let adCoinBalance = 0;
        let selectedMethod = 'money';
        let currentCostMoney = 0;
        let currentCostAdCoin = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = db.getCurrentUser();
            if (!currentUser) return;

            // Load user info
            document.getElementById('user-welcome').textContent = `WELCOME, ${(currentUser.ign || currentUser.fullName || 'OPERATIVE').toUpperCase()}`;
            document.getElementById('user-region').textContent = currentUser.region || 'INDIA';

            await loadBalances();

            // Load matches count
            const tournaments = await db.getTournaments();
            let matchCount = 0;
            for (const t of tournaments) {
                const regs = await db.getRegistrations(t.id);
                if (regs.find(r => r.userEmail === currentUser.email)) matchCount++;
            }
            document.getElementById('stat-matches').textContent = matchCount;

            // Load tournaments
            await loadTournaments();
        });

        async function loadBalances() {
            userBalance = await db.getWalletBalance(currentUser.email);
            adCoinBalance = await db.getAdCoinBalance(currentUser.email);
            document.getElementById('stat-wallet').textContent = '‚Çπ' + userBalance;
            document.getElementById('nav-balance').textContent = '‚Çπ' + userBalance;
        }

        async function loadTournaments() {
            const grid = document.getElementById('tour-grid');
            try {
                allTournaments = await db.getTournaments();
                const upcoming = allTournaments.filter(t => t.status !== 'completed');
                renderTournaments(upcoming);
            } catch (err) {
                grid.innerHTML = '<p style="color:red">Error loading tournaments</p>';
            }
        }

        async function renderTournaments(tournaments) {
            const grid = document.getElementById('tour-grid');

            if (tournaments.length === 0) {
                grid.innerHTML = '<div class="card" style="grid-column:span 2;text-align:center"><p style="color:var(--color-text-muted)">No tournaments available. Check back later!</p></div>';
                return;
            }

            // Get registrations for each tournament
            const html = await Promise.all(tournaments.map(async (t) => {
                const registrations = await db.getRegistrations(t.id);
                const isJoined = registrations.find(r => r.userEmail === currentUser.email);
                const slots = t.teamSize || 48;
                const filledSlots = registrations.length;
                const isFull = filledSlots >= slots;
                const isLive = t.trackingState === 'live';
                const isPaid = t.entryFee > 0;

                let statusBadge = '';
                let actionButton = '';

                if (isLive) {
                    statusBadge = '<span class="badge live">LIVE</span>';
                    if (isJoined) {
                        actionButton = `<a href="tournament.html?id=${t.id}" class="btn btn-primary" style="width:100%;text-decoration:none">VIEW ROOM DETAILS</a>`;
                    } else {
                        actionButton = '<button class="btn" disabled style="width:100%">MATCH IN PROGRESS</button>';
                    }
                } else if (isJoined) {
                    statusBadge = '<span class="badge" style="background:var(--color-secondary);color:black">JOINED</span>';
                    actionButton = `<a href="tournament.html?id=${t.id}" class="btn" style="width:100%;text-decoration:none">VIEW DETAILS</a>`;
                } else if (isFull) {
                    actionButton = '<button class="btn" disabled style="width:100%">SLOTS FULL</button>';
                } else {
                    const btnText = isPaid ? `PAY ‚Çπ${t.entryFee} & JOIN` : 'JOIN NOW';
                    actionButton = `<button onclick="openJoinModal('${t.id}')" class="btn btn-primary" style="width:100%">${btnText}</button>`;
                }

                return `
                    <div class="card">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px">
                            <div>
                                <h3 style="color:var(--color-primary);margin-bottom:5px">${t.title}</h3>
                                <div style="display:flex;gap:8px;flex-wrap:wrap">
                                    <span class="badge">${t.map || 'BERMUDA'}</span>
                                    <span class="badge">${t.mode || 'SOLO'}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:1.5rem;color:${isPaid ? 'var(--color-primary)' : 'var(--color-secondary)'};font-family:var(--font-heading)">${isPaid ? '‚Çπ' + t.entryFee : 'FREE'}</div>
                            </div>
                        </div>

                        <div style="display:flex;justify-content:space-between;color:#888;font-size:0.9rem;margin-bottom:15px">
                            <span>üìÖ ${new Date(t.date).toLocaleDateString()}</span>
                            <span>‚è∞ ${new Date(t.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>

                        <div style="margin-bottom:15px">
                            <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:#666;margin-bottom:5px">
                                <span>SLOTS</span>
                                <span>${filledSlots}/${slots}</span>
                            </div>
                            <div style="background:rgba(255,255,255,0.1);height:8px;border-radius:4px;overflow:hidden">
                                <div style="background:linear-gradient(90deg, var(--color-primary), var(--color-secondary));height:100%;width:${(filledSlots / slots) * 100}%"></div>
                            </div>
                        </div>

                        <div style="display:flex;gap:10px;color:#888;font-size:0.85rem;margin-bottom:20px">
                            <span>üèÜ ‚Çπ${t.prizeFirst || 0}</span>
                            <span>üíÄ ‚Çπ${t.perKillBonus || 0}/kill</span>
                        </div>

                        ${actionButton}
                    </div>
                `;
            }));

            grid.innerHTML = html.join('');
        }

        function filterTournaments(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-filter="${type}"]`).classList.add('active');

            let filtered = allTournaments.filter(t => t.status !== 'completed');
            if (type === 'free') {
                filtered = filtered.filter(t => !t.entryFee || t.entryFee === 0);
            } else if (type === 'paid') {
                filtered = filtered.filter(t => t.entryFee > 0);
            }
            renderTournaments(filtered);
        }

        async function openJoinModal(id) {
            selectedTournament = allTournaments.find(t => t.id === id);
            if (!selectedTournament) return;

            await loadBalances();

            document.getElementById('join-title').textContent = selectedTournament.title;
            document.getElementById('join-info').textContent = `${selectedTournament.map} | ${selectedTournament.mode}`;

            // Calculate Costs
            const fee = selectedTournament.entryFee || 0;
            currentCostMoney = fee;
            // Conversion: 1.2x of fee (if fee is 100, custom coins = 120)
            // Assuming 1 Coin ~ 1 Tk value for the user?
            // "user need watch that much of ad so i ca bale to earn 120 tk" -> 120 value to admin.
            // If 1 Coin = 1 Ad.
            // And 1 Ad = some small revenue.
            // User requested explicit "earn 120 tk" worth.
            // I'll set AdCoin cost = Fee * 120/100 = 1.2x.
            // Assuming 1 Coin = 1 unit of value similar to Tk in the user's mind (or 1 ad = 1 coin).
            // Let's explicitly set it to 1.2x.
            currentCostAdCoin = Math.ceil(fee * 1.2);

            document.getElementById('cost-money').textContent = '‚Çπ' + currentCostMoney;
            document.getElementById('cost-adcoin').textContent = 'ü™ô ' + currentCostAdCoin;
            document.getElementById('bal-money').textContent = '‚Çπ' + userBalance;
            document.getElementById('bal-adcoin').textContent = 'ü™ô ' + adCoinBalance;

            if (fee === 0) {
                // Free tournament, just confirm
                selectPaymentMethod('money');
                document.getElementById('payment-options').style.display = 'none';
            } else {
                document.getElementById('payment-options').style.display = 'block';
                selectPaymentMethod('money'); // Default
            }

            document.getElementById('join-modal').classList.add('active');
        }

        function selectPaymentMethod(method) {
            selectedMethod = method;
            document.getElementById('pm-money').classList.toggle('active', method === 'money');
            document.getElementById('pm-adcoin').classList.toggle('active', method === 'adcoin');

            validateJoinButton();

            // Show ad watch section if adcoin selected and low balance
            const adSection = document.getElementById('ad-watch-section');
            if (method === 'adcoin' && adCoinBalance < currentCostAdCoin) {
                adSection.style.display = 'block';
            } else {
                adSection.style.display = 'none';
            }
        }

        function validateJoinButton() {
            const btn = document.getElementById('join-btn');
            let sufficient = false;

            if (selectedMethod === 'money') {
                if (userBalance >= currentCostMoney) sufficient = true;
            } else {
                if (adCoinBalance >= currentCostAdCoin) sufficient = true;
            }

            // Always allow if free
            if (currentCostMoney === 0) sufficient = true;

            if (sufficient) {
                btn.disabled = false;
                btn.textContent = 'PAY & JOIN';
            } else {
                btn.disabled = true;
                btn.textContent = 'INSUFFICIENT FUNDS';
            }
        }

        async function handleWatchAd() {
            const btn = document.querySelector('#ad-watch-section button');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'üì∫ VIEWING AD (5s)...';

            // Mock Ad
            await new Promise(r => setTimeout(r, 5000));

            await db.watchAd(currentUser.email);
            await loadBalances();

            // Update UI
            document.getElementById('bal-adcoin').textContent = 'ü™ô ' + adCoinBalance;
            btn.textContent = '‚úÖ EARNED +1';
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = originalText;
                validateJoinButton();
                // Check if we can hide section now
                if (adCoinBalance >= currentCostAdCoin) {
                    document.getElementById('ad-watch-section').style.display = 'none';
                }
            }, 1000);
        }

        function closeJoinModal() {
            document.getElementById('join-modal').classList.remove('active');
            selectedTournament = null;
        }

        async function confirmJoin() {
            if (!selectedTournament) return;

            const btn = document.getElementById('join-btn');
            btn.disabled = true;
            btn.textContent = 'PROCESSING...';

            try {
                // Deduct if paid
                if (currentCostMoney > 0) {
                    if (selectedMethod === 'money') {
                        await db.deductFunds(currentUser.email, currentCostMoney, 'entry_fee', { tournamentId: selectedTournament.id }, 'money');
                    } else {
                        await db.deductFunds(currentUser.email, currentCostAdCoin, 'entry_fee_ad', { tournamentId: selectedTournament.id }, 'adcoin');
                    }
                }

                // Join tournament
                await db.joinTournament(selectedTournament.id, currentUser, {
                    bkash: document.getElementById('join-bkash').value
                });
                await db.logAnalytics('tournament_joined', { tournamentId: selectedTournament.id, fee: currentCostMoney, method: selectedMethod });

                alert('‚úÖ Successfully joined! Good luck in the match.');
                closeJoinModal();

                await loadBalances();
                await loadTournaments();

            } catch (err) {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'PAY & JOIN';
            }
        }
    </script>
    <style>
        .filter-btn {
            font-size: 0.85rem;
            padding: 8px 20px;
        }

        .filter-btn.active {
            background: var(--color-primary);
            color: white;
        }

        .payment-card {
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .payment-card:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .payment-card.active {
            border-color: var(--color-primary);
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }
    </style>
    <div id="custom-html-container"></div>
    <script>
        // Apply Custom Injections
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const settings = await db.getSettings();
                if (settings) {
                    // Apply Custom Code
                    if (settings.customCode) {
                        const { html, css, js } = settings.customCode;
                        if (css) {
                            const style = document.createElement('style');
                            style.textContent = css;
                            document.head.appendChild(style);
                        }
                        if (html) {
                            document.getElementById('custom-html-container').innerHTML = html;
                        }
                        if (js) {
                            const script = document.createElement('script');
                            script.textContent = js;
                            document.body.appendChild(script);
                        }
                    }

                    // Apply AdSense Auto Ads
                    if (settings.adsenseClientId) {
                        const adScript = document.createElement('script');
                        adScript.async = true;
                        adScript.src = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${settings.adsenseClientId}`;
                        adScript.crossOrigin = "anonymous";
                        document.head.appendChild(adScript);
                        console.log("AdSense Auto Ads initialized");
                    }
                }
            } catch (err) {
                console.log('Error applying settings/injections');
            }
        });
    </script>
</body>

</html>
```