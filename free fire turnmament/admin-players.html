<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Players - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>

    <div class="admin-layout">
        <nav class="admin-sidebar">
            <div class="sidebar-brand">
                <h2>AETHER <span style="color:var(--color-primary)">//</span> ADMIN</h2>
            </div>
            <ul class="sidebar-nav">
                <li><a href="admin-dashboard.html">üìä Dashboard</a></li>
                <li><a href="hidden_control.html">‚ûï Create Tournament</a></li>
                <li><a href="admin-tournaments.html">üéÆ Tournaments</a></li>
                <li><a href="admin-players.html" class="active">üë• Players</a></li>
                <li><a href="admin-payments.html">üí≥ Payments</a></li>
                <li><a href="admin-withdrawals.html">üí∏ Withdrawals</a></li>
                <li><a href="admin-wallet.html">üí∞ Earnings</a></li>
                <li><a href="admin-settings.html">‚öôÔ∏è Settings</a></li>
            </ul>
            <div class="sidebar-footer"><button onclick="handleLogout()" class="btn" style="width:100%">LOGOUT</button>
            </div>
        </nav>

        <main class="admin-main">
            <div class="admin-header">
                <h1>PLAYER DATABASE</h1>
                <p id="player-count" style="color:var(--color-text-muted)">0 registered players</p>
            </div>

            <div class="filter-bar">
                <input type="text" id="search" class="form-control" placeholder="Search by name, UID, email..."
                    oninput="filterPlayers()">
                <select id="filter-region" class="form-control" onchange="filterPlayers()">
                    <option value="">All Regions</option>
                    <option value="IND">India</option>
                    <option value="BD">Bangladesh</option>
                    <option value="SG">Singapore</option>
                    <option value="BR">Brazil</option>
                </select>
            </div>

            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>PLAYER</th>
                            <th>UID</th>
                            <th>EMAIL</th>
                            <th>WALLET</th>
                            <th>REGION</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="player-list"></tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let allPlayers = [];

        document.addEventListener('DOMContentLoaded', loadPlayers);

        async function loadPlayers() {
            const tbody = document.getElementById('player-list');
            try {
                allPlayers = await db.getAllUsers();

                // Get wallet balances
                for (let p of allPlayers) {
                    p.walletBalance = await db.getWalletBalance(p.email);
                }

                document.getElementById('player-count').textContent = allPlayers.length + ' registered players';
                renderPlayers(allPlayers);
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="6" style="color:red">Error loading players</td></tr>';
            }
        }

        function renderPlayers(players) {
            const tbody = document.getElementById('player-list');
            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="color:var(--color-text-muted)">No players found</td></tr>';
                return;
            }

            tbody.innerHTML = players.map(p => `
                <tr>
                    <td>
                        <strong style="color:white">${p.ign || p.fullName || 'Unknown'}</strong>
                        <br><span style="color:#666;font-size:0.8rem">${p.fullName || ''}</span>
                    </td>
                    <td style="color:var(--color-secondary)">${p.uid || '‚Äî'}</td>
                    <td style="color:#888">${p.email}</td>
                    <td style="color:var(--color-primary)">‚Çπ${p.walletBalance || 0}</td>
                    <td>${p.region || '‚Äî'}</td>
                    <td>
                        <button onclick="addBonus('${p.email}')" class="btn action-btn approve">ADD BONUS</button>
                        <button onclick="viewDetails('${p.email}')" class="btn action-btn">VIEW</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterPlayers() {
            const search = document.getElementById('search').value.toLowerCase();
            const region = document.getElementById('filter-region').value;

            let filtered = allPlayers;
            if (search) {
                filtered = filtered.filter(p =>
                    (p.ign?.toLowerCase() || '').includes(search) ||
                    (p.fullName?.toLowerCase() || '').includes(search) ||
                    (p.uid || '').includes(search) ||
                    (p.email?.toLowerCase() || '').includes(search)
                );
            }
            if (region) {
                filtered = filtered.filter(p => p.region === region);
            }
            renderPlayers(filtered);
        }

        async function addBonus(email) {
            const amount = prompt('Enter bonus amount (‚Çπ):');
            if (!amount || isNaN(amount)) return;

            try {
                await db.addFunds(email, parseFloat(amount), 'admin_bonus', { addedBy: 'admin' });
                alert('Bonus added successfully!');
                loadPlayers();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function viewDetails(email) {
            const player = allPlayers.find(p => p.email === email);
            if (!player) return;

            alert(`Player Details:\n\nIGN: ${player.ign}\nUID: ${player.uid}\nEmail: ${player.email}\nPhone: ${player.phone || 'N/A'}\nRegion: ${player.region || 'N/A'}\nWallet: ‚Çπ${player.walletBalance}`);
        }
    </script>
</body>

</html>
